Running the code
================

The code to extract timeseries from a given CNeuroMod dataset can be run with
a simple command line that specifies the dataset and the parcellation to use.

For example,

.. code-block::

   python -m timeseries.run dataset=shinobi parcellation=mist444

Under the hood, the code relies on a combination of .yaml config files.
We use `Hydra <https://hydra.cc/>`_ to flexibly combine datasets, parcellation
atlases and denoising strategies.

Users can call the existing config files from the command line, or customize
their own as explained below. The parameters to specify are described here.

1. Dataset
----------

Dataset config files are saved under
``timeseries/config/dataset/<dset_name>.yaml``

When launching the script, you must specify the name of an input dataset.
The name must correspond to one of the ``<dset_name>.yaml`` files.

.. code-block::

    python -m timeseries.run dataset=movie10 parcellation=mist444


The script will look for the input data under
``<data_dir>/<dset_name>.fmriprep``

By default, ``<data_dir>`` corresponds to ``./data``.
This default can be overriden at the command line to match another dataset location,
like this.

.. code-block::

    python -m timeseries.run dataset=movie10 data_dir=/home/user/project/my_data_dir parcellation=mist444

Alternatively, the ``data_dir`` and ``dset_name`` variables can be modified
directly in a dataset ``timeseries/config/dataset/<dset_name>.yaml`` file to reflect the data location.



2. Output Settings
------------------

The **default output directory** (``./outputs``) is specified as ``output_dir`` in
``timeseries/config/base.yaml``.

If needed, this default can be overridden at the command line when launching the code.

.. code-block::

    python -m timeseries.run dataset=friends parcellation=mist444 output_dir=/home/user/project/results/my_analysis

This default can also be changed manually for all analyses directly in ``timeseries/config/base.yaml``


By default, a subject's timeseries will be exported as ``<output_dir>/<dset_name>/<parcel_name>_<desc>/<subject>/func/<subject>_<dset_name>_<space>_<parcel_name>_<desc>_timeseries.h5``

For example,

.. code-block::

  ./outputs/friends/MIST_444/sub-01/func/sub-01_task-friends_space-MNI152NLin2009cAsym_atlas-MIST_desc-444_timeseries.h5
  ./outputs/friends/fLocVisionKanwisher_bodyEBA/sub-01/func/sub-01_task-friends_space-T1w_atlas-fLocVisionKanwisher_label-bodyEBA_timeseries.h5

Subject-specific functional masks and ROI/parcellation masks generated by the script are saved as

.. code-block::

  <output_dir>/<dset_name>/<parcel_name>_<desc>/<subject>/func/<subject>_<dset_name>_<space>_label-<GM, boldGMIntersect>_<gm_mask_name>_mask.nii.gz
  <output_dir>/<dset_name>/<parcel_name>_<desc>/<subject>/func/<subject>_<dset_name>_<space>_<parcel_name>_<desc>_<mask, dseg>.nii.gz


To save timeseries in subject directories at the root of the (specified or default) output directory, 
you can manually set the ``save_to_root`` parameter to  ``True`` in ``timeseries/config/base.yaml``.


The **type of compression** (if any) applied to the timeseries arrays exported in
.HDF5 files is specified in ``timeseries/config/base.yaml``.
Options for the field ``compression`` are ``null``, ``gzip`` and ``lzf``. If ``compression = gzip``,
the `compression level can be set <https://docs.h5py.org/en/stable/high/dataset.html>`_ with ``compression_opts = [0, 10[``.

The default is ``gzip`` with a compression level of ``4``. To export uncompressed timeseries,
you can override the compression parameters like this.

.. code-block::

  python -m timeseries.run dataset=movie10 parcellation=mist444 compression=null


3. Subject List
---------------

By default, the script will process all subjects whose data are found under
``<data_dir>/<dset_name>.fmriprep``

To limit the analysis to a subset of subjects, override the ``subject_list: null``
parameter in ``timeseries/config/base.yaml`` when
launching the script.

.. code-block::

   python -m timeseries.run dataset=friends subject_list=[01,02,03] parcellation=mist444

4. Denoising strategy
---------------------
The script uses ``nilearn.interfaces.fmriprep.load_confounds`` to retrieve
noise confounds from fmri.prep output to denoise the BOLD data.

Choices of denoising strategies are saved under
``timeseries/config/denoise/<denoise_strategy>.yaml``

Each denoise .yaml file contains parameters designed to pass to
`nilearn's load_confounds_strategy <https://nilearn.github.io/dev/modules/generated/nilearn.interfaces.fmriprep.load_confounds_strategy.html>`_.

By default, the ``simple+gsr`` strategy is called from the base config file
``timeseries/config/base.yaml``. You can override this choice
at the command line.

.. code-block::

  python -m timeseries.run dataset=friends parcellation=mist444 denoise=scrubbing.5+gsr


You can also create a custom strategy by generating your own
``<my_denoise_strategy>.yaml`` config file and save it in
``timeseries/config/denoise``

In a .yaml file, define your custom strategy in the following format:

.. code-block::

  name: <name_of_the_strategy>
    function: <load_confounds_strategy>
    parameters:
      <function_parameters>: <options>
      ....


5. Smoothing
-------------------------------

The default smoothing kernel size is set to 5.0 in the base config file.
You can override this choice at the command line.

.. code-block::

    python -m timeseries.run dataset=friends parcellation=mist444 smoothing_fwhm=3.0



6. Parcellation
---------------

Config files that specify the timeseries parcellation parameters are saved under
``timeseries/config/parcellation/<parcelation_name>.yaml``

The parcellation must be specified when launching the script.

.. code-block::

    python -m timeseries.run dataset=mario3 parcellation=parcelation_name

Custom parcellations can be added by creating <parcelation_name>.yaml files under
``timeseries/config/parcellation`` and specifying the path to the parcellation
atlas or ROI mask needed to mask the signal (see below).

The following parameters need to be specified in the parcellation .yaml file:

* ``space``. This field specifies whether to process fMRI data in native (T1w) or in standard (MNI) space. Space must match the specified grey matter and parcellation atlas/roi mask. Options = [``T1w``, ``MNI152NLin2009cAsym``].
* ``gm_path``. Full or relative path to a grey matter mask (.nii.gz) to mask the BOLD signal during denoising (before applying the parcellation or ROI mask). To use subject-specific masks, replace the subject number with ``sub-*`` in the file path.
* ``use_template_gm``. Boolean. Set to ``True`` if a standard grey matter mask is used for all subjects. Set to ``False`` if an individual mask is loaded for each subject (replace the subject number with ``sub-*`` in ``gm_path``).
* ``resample_gm``. Boolean. Set to ``True`` if the grey matter mask needs to be resampled to match the subject's EPI data (e.g., if using a template or a GM mask whose resolution differs from the EPI data).
* ``gm_name``. Short name for the grey matter mask used to mask the BOLD signal during denoising (before applying the parcellation or ROI mask), either on its own or in conjunction with a mask derived from the functional runs. This tag is used to label the final mask that delineates the voxels that contributed to the timeseries for each subject.
* ``build_func_mask``. Boolean. Set to ``True`` to generate a functional mask from the EPI runs, used in conjunction with the grey matter mask specified with ``gm_path`` to delineate the voxels contributing to the timeseries. Set to ``False`` to mask voxels using only the grey matter mask. 
* ``parcel_type``. Choices = [``dseg``, ``probseg``, ``mask``]. Whether the specified ``parcellation`` is discrete, probabilistic or an ROI mask. Select ``dseg`` or ``probseg`` (depending on the atlas) to extract average timeseries from each parcel in the parcellation atlas. Select ``mask`` to extract timeseries from each voxel within an ROI mask (``parcellation`` must point to a binary mask).
* ``parcellation``. Full or relative path to a parcellation (.nii.gz) or ROI mask that specifies the ROI(s) from which to extract the timeseries. To use subject-specific parcellations / ROI masks, replace the subject number with ``sub-*`` in the file path.
* ``use_template_parcel``. Boolean. Set to ``True`` if ``parcellation`` is a standard atlas (e.g., ``MIST``, ``Schaefer18``, ``DiFuMo``) or an ROI mask used for all subjects. Set to ``False`` if an individual parcellation or ROI mask is used for each subject (replace the subject number with ``sub-*`` in ``parcellation``).
* ``mask_parcel``. Boolean. Set to ``True`` to mask the parcelation atlas with the mask applied to the brain voxels during denoising, in order to exclude out-of-mask voxels whose values are set to 0 from the averaging of parcel signal.
* ``parcel_name``. Used to label the output. The name of the parcellation used to define an ROI or a series of parcels (e.g., ``MIST``, ``Schaefer18``).
* ``desc``. Used to label the output. Specify the grain of parcellation to extract parcelwise timeseries (e.g., ``400Parcels7Networks`` for the ``Schaefer18`` atlas) or the name of the ROI from which to extract voxelwise timeseries (e.g., ``faceFFA`` for the ``fLocVisionTask`` parcellation, ``defaultMode`` for the ``Yeo7Networks`` parcellation).
